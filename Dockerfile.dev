# Development Dockerfile for hot reload
FROM node:20-alpine

# Install pnpm globally
RUN npm install -g pnpm

# Set working directory
WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml ./

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Generate Prisma clients (will be regenerated on file changes)
RUN cd apps/accounts-service && npx prisma generate && cd ../..
RUN cd apps/provider-directory-service && npx prisma generate && cd ../..
RUN cd apps/booking-service && npx prisma generate && cd ../..
RUN cd apps/content-service && npx prisma generate && cd ../..
RUN cd apps/notification-service && npx prisma generate && cd ../..

# Create non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S medicalink -u 1001

# Change ownership
RUN chown -R medicalink:nodejs /app
USER medicalink

# Expose port
EXPOSE 3000

# Default command
CMD ["pnpm", "run", "start:dev"]